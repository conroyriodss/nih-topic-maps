<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NIH Topic Map</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { padding: 30px; border-bottom: 1px solid #e5e7eb; }
        h1 { font-size: 32px; margin-bottom: 8px; color: #1f2937; }
        .subtitle { font-size: 14px; color: #6b7280; }
        .controls { padding: 20px 30px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .control-row { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-end; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 12px; font-weight: 600; color: #374151; text-transform: uppercase; }
        select, input[type="range"] { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
        select { background: white; }
        input[type="range"] { width: 120px; }
        button { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        button:hover { background: #2563eb; }
        .stats { display: flex; gap: 15px; flex-wrap: wrap; padding: 20px 30px; background: #f9fafb; }
        .stat { background: #ecfdf5; padding: 15px 20px; border-radius: 6px; border-left: 4px solid #10b981; text-align: center; flex: 0 1 auto; }
        .stat-value { font-size: 24px; font-weight: 700; color: #1f2937; }
        .stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .plot-container { padding: 30px; }
        #chart { height: 750px; }
        .message { padding: 30px; text-align: center; }
        .msg-good { background: #dbeafe; color: #0c4a6e; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NIH Research Topic Map</h1>
            <div class="subtitle">50,000 grants (FY2000-2024) • 100 research topics • UMAP semantic clustering</div>
        </div>
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>Color By</label>
                    <select id="colorBy" onchange="updateChart()">
                        <option value="topic">Topic (RCDC Categories)</option>
                        <option value="year">Fiscal Year</option>
                        <option value="ic">Institute</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Year Min</label>
                    <input type="range" id="yearMin" min="2000" max="2023" value="2000" onchange="updateChart()">
                </div>
                <div class="control-group">
                    <label>Year Max</label>
                    <input type="range" id="yearMax" min="2001" max="2024" value="2024" onchange="updateChart()">
                </div>
                <button onclick="resetFilters()">RESET</button>
            </div>
        </div>
        <div class="stats">
            <div class="stat"><div class="stat-value" id="countVal">0</div><div class="stat-label">Grants</div></div>
            <div class="stat"><div class="stat-value" id="fundVal">$0B</div><div class="stat-label">FY Award</div></div>
            <div class="stat"><div class="stat-value" id="ltVal">$0B</div><div class="stat-label">Lifetime</div></div>
            <div class="stat"><div class="stat-value" id="yrsVal">0</div><div class="stat-label">Avg Years</div></div>
            <div class="stat"><div class="stat-value" id="topicVal">100</div><div class="stat-label">Topics</div></div>
        </div>
        <div id="message"></div>
        <div class="plot-container"><div id="chart"></div></div>
    </div>
    <script>
        let allData = [];
        let topicLabels = {};
        const topicColors = {};
        
        // Generate 100 distinct colors
        for (let i = 0; i < 100; i++) {
            const h = (i * 3.6) % 360;
            topicColors[i] = 'hsl(' + Math.round(h) + ', 70%, 50%)';
        }
        
        async function loadData() {
            try {
                document.getElementById('message').innerHTML = '<div class="msg-good">Loading 50,000 grants...</div>';
                const url = 'https://storage.googleapis.com/od-cl-odss-conroyri-nih-embeddings/sample/hybrid_viz_data_enriched.json?t=' + Date.now();
                const response = await fetch(url);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                
                allData = await response.json();
                if (!allData || allData.length === 0) throw new Error('No data loaded');
                
                // Build topic labels map
                allData.forEach(d => {
                    if (!(d.topic in topicLabels)) {
                        topicLabels[d.topic] = d.topic_label || ('Topic ' + d.topic);
                    }
                });
                
                console.log('Loaded ' + allData.length + ' records');
                console.log('Topics: ' + Object.keys(topicLabels).length);
                console.log('Sample:', allData[0]);
                
                document.getElementById('message').innerHTML = '<div class="msg-good">✓ Loaded ' + allData.length.toLocaleString() + ' grants | Topics with labels loaded</div>';
                updateChart();
            } catch (err) {
                document.getElementById('message').innerHTML = '<div class="msg-good" style="background: #fee2e2; color: #7f1d1d;">ERROR: ' + err.message + '</div>';
                console.error(err);
            }
        }
        
        function updateChart() {
            if (allData.length === 0) return;
            
            const colorBy = document.getElementById('colorBy').value;
            const yearMin = parseInt(document.getElementById('yearMin').value);
            const yearMax = parseInt(document.getElementById('yearMax').value);
            
            const filtered = allData.filter(d => d.year >= yearMin && d.year <= yearMax);
            
            document.getElementById('countVal').textContent = filtered.length.toLocaleString();
            
            const fyTotal = filtered.reduce((s, d) => s + (d.funding || 0), 0);
            const ltTotal = filtered.reduce((s, d) => s + (d.lifetime_funding || 0), 0);
            const avgYears = filtered.reduce((s, d) => s + (d.total_years || 0), 0) / Math.max(1, filtered.length);
            const uniqueTopics = new Set(filtered.map(d => d.topic)).size;
            
            document.getElementById('fundVal').textContent = '$' + (fyTotal / 1e9).toFixed(2) + 'B';
            document.getElementById('ltVal').textContent = '$' + (ltTotal / 1e9).toFixed(2) + 'B';
            document.getElementById('yrsVal').textContent = avgYears.toFixed(1);
            document.getElementById('topicVal').textContent = uniqueTopics;
            
            let traces = [];
            
            if (colorBy === 'topic') {
                // Group by topic
                const groups = {};
                filtered.forEach(d => {
                    if (!groups[d.topic]) groups[d.topic] = [];
                    groups[d.topic].push(d);
                });
                
                // Create trace for each topic with label
                Object.keys(groups).sort((a,b) => parseInt(a) - parseInt(b)).forEach(topic => {
                    const topicNum = parseInt(topic);
                    const group = groups[topic];
                    const label = topicLabels[topicNum] || ('Topic ' + topicNum);
                    
                    const hoverTexts = group.map(d => {
                        const title = (d.title || '').substring(0, 60);
                        const lt = d.lifetime_funding ? '$' + (d.lifetime_funding / 1e6).toFixed(1) + 'M' : 'N/A';
                        const yrs = d.total_years || 1;
                        return '<b>' + title + '</b><br/>Topic: ' + label + '<br/>Lifetime: ' + lt + '<br/>Years: ' + yrs;
                    });
                    
                    traces.push({
                        x: group.map(d => d.x),
                        y: group.map(d => d.y),
                        text: hoverTexts,
                        mode: 'markers',
                        type: 'scattergl',
                        name: label.substring(0, 30),
                        marker: {
                            size: 4,
                            color: topicColors[topicNum],
                            opacity: 0.65,
                            line: { width: 0 }
                        },
                        hoverinfo: 'text',
                        showlegend: false
                    });
                });
            } else if (colorBy === 'year') {
                traces.push({
                    x: filtered.map(d => d.x),
                    y: filtered.map(d => d.y),
                    text: filtered.map(d => {
                        const title = (d.title || '').substring(0, 60);
                        const label = topicLabels[d.topic] || ('Topic ' + d.topic);
                        const lt = d.lifetime_funding ? '$' + (d.lifetime_funding / 1e6).toFixed(1) + 'M' : 'N/A';
                        const yrs = d.total_years || 1;
                        return '<b>' + title + '</b><br/>Year: ' + d.year + '<br/>Topic: ' + label + '<br/>Lifetime: ' + lt + '<br/>Years: ' + yrs;
                    }),
                    mode: 'markers',
                    type: 'scattergl',
                    marker: {
                        size: 4,
                        color: filtered.map(d => d.year),
                        colorscale: 'Viridis',
                        opacity: 0.65,
                        colorbar: { title: 'Year', thickness: 10 },
                        line: { width: 0 }
                    },
                    hoverinfo: 'text'
                });
            } else {
                // Group by IC
                const groups = {};
                filtered.forEach(d => {
                    if (!groups[d.ic]) groups[d.ic] = [];
                    groups[d.ic].push(d);
                });
                
                Object.keys(groups).sort().forEach(ic => {
                    const group = groups[ic];
                    traces.push({
                        x: group.map(d => d.x),
                        y: group.map(d => d.y),
                        text: group.map(d => {
                            const title = (d.title || '').substring(0, 60);
                            const label = topicLabels[d.topic] || ('Topic ' + d.topic);
                            const lt = d.lifetime_funding ? '$' + (d.lifetime_funding / 1e6).toFixed(1) + 'M' : 'N/A';
                            const yrs = d.total_years || 1;
                            return '<b>' + title + '</b><br/>IC: ' + ic + '<br/>Topic: ' + label + '<br/>Lifetime: ' + lt + '<br/>Years: ' + yrs;
                        }),
                        mode: 'markers',
                        type: 'scattergl',
                        name: ic,
                        marker: {
                            size: 4,
                            opacity: 0.65,
                            line: { width: 0 }
                        },
                        hoverinfo: 'text',
                        showlegend: true
                    });
                });
            }
            
            Plotly.newPlot('chart', traces, {
                hovermode: 'closest',
                margin: { l: 60, r: 60, t: 40, b: 60 },
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                xaxis: {
                    showgrid: true,
                    gridwidth: 1,
                    gridcolor: '#e5e7eb',
                    title: 'UMAP Dimension 1 (Semantic Similarity)',
                    zeroline: false
                },
                yaxis: {
                    showgrid: true,
                    gridwidth: 1,
                    gridcolor: '#e5e7eb',
                    title: 'UMAP Dimension 2 (Semantic Similarity)',
                    zeroline: false
                }
            }, { responsive: true, displayModeBar: true, displaylogo: false });
        }
        
        function resetFilters() {
            document.getElementById('yearMin').value = 2000;
            document.getElementById('yearMax').value = 2024;
            document.getElementById('colorBy').value = 'topic';
            updateChart();
        }
        
        window.addEventListener('load', loadData);
    </script>
</body>
</html>
