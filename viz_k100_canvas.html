<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIH Topic Map - Canvas Optimized</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 5px 0 0 0; font-size: 13px; opacity: 0.9; }
        .container { display: flex; height: calc(100vh - 70px); }
        .controls { width: 320px; background: white; border-right: 1px solid #e0e0e0; overflow-y: auto; padding: 20px; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-weight: 600; font-size: 12px; color: #333; text-transform: uppercase; margin-bottom: 8px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; margin-bottom: 6px; }
        .stats { background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 12px; }
        .stat-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .stat-label { color: #666; }
        .stat-value { font-weight: 600; color: #667eea; }
        .viz-container { flex: 1; position: relative; background: white; }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }
        .tooltip { position: absolute; background: rgba(0,0,0,0.95); color: white; padding: 12px 15px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 50; max-width: 350px; display: none; }
        .tooltip-title { font-weight: 600; margin-bottom: 8px; color: #a8b3ff; }
        .tooltip-item { margin: 4px 0; }
        .tooltip-label { color: #aaa; display: inline-block; width: 70px; }
        .legend { position: absolute; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 11px; max-width: 200px; max-height: 350px; overflow-y: auto; }
        .legend-title { font-weight: 600; margin-bottom: 10px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; margin-right: 8px; }
        button { width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; }
        button:hover { background: #5568d3; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ§¬ NIH Topic Map - 100 PROJECT_TERMS Clusters</h1>
        <p>43,320 grants | Canvas-Optimized | Fast & Stable</p>
    </div>
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label>Color By</label>
                <select id="colorBy">
                    <option value="cluster">Topic Cluster</option>
                    <option value="ic">NIH IC</option>
                    <option value="year">Fiscal Year</option>
                </select>
            </div>
            <div class="control-group">
                <label>Filter Topics</label>
                <select id="topicFilter" multiple size="8"><option value="all" selected>All Topics</option></select>
            </div>
            <div class="control-group">
                <label>Filter ICs</label>
                <select id="icFilter" multiple size="6"><option value="all" selected>All ICs</option></select>
            </div>
            <div class="control-group">
                <label>Year Range</label>
                <input type="number" id="yearMin" min="2000" max="2024" value="2000">
                <input type="number" id="yearMax" min="2000" max="2024" value="2024">
            </div>
            <div class="control-group"><button onclick="resetFilters()">Reset Filters</button></div>
            <div class="stats">
                <div class="stat-item"><span class="stat-label">Visible:</span><span class="stat-value" id="visibleCount">0</span></div>
                <div class="stat-item"><span class="stat-label">Total:</span><span class="stat-value">43,320</span></div>
                <div class="stat-item"><span class="stat-label">Topics:</span><span class="stat-value">100</span></div>
                <div class="stat-item"><span class="stat-label">ICs:</span><span class="stat-value" id="icCount">--</span></div>
            </div>
        </div>
        <div class="viz-container">
            <div class="loading">Loading...</div>
            anvas id="viz"></canvas>
            <div id="legend" class="legend"></div>
            <div class="tooltip" id="tooltip"></div>
        </div>
    </div>
    <script>
        let vizData,canvas,ctx,xScale,yScale,colorScale,filteredPoints=[];
        let filters={topics:[],ics:[],yearMin:2000,yearMax:2024,colorBy:'cluster'};
        
        fetch('https://storage.googleapis.com/od-cl-odss-conroyri-nih-embeddings/sample/viz_data_project_terms_k100_final.json')
            .then(r=>r.json()).then(data=>{
                vizData=data;document.querySelector('.loading').style.display='none';
                initCanvas();populateFilters();update();
            });
        
        function initCanvas(){
            canvas=document.getElementById('viz');
            const c=canvas.parentElement;
            canvas.width=c.clientWidth;canvas.height=c.clientHeight;
            ctx=canvas.getContext('2d');
            const xe=d3.extent(vizData.points,d=>d.x),ye=d3.extent(vizData.points,d=>d.y),p=20;
            xScale=d3.scaleLinear().domain(xe).range([p,canvas.width-p]);
            yScale=d3.scaleLinear().domain(ye).range([canvas.height-p,p]);
            canvas.onmousemove=e=>{
                const r=canvas.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;
                for(let d of filteredPoints){
                    const px=xScale(d.x),py=yScale(d.y);
                    if(Math.sqrt((mx-px)**2+(my-py)**2)<=5){showTooltip(e,d);return;}
                }
                hideTooltip();
            };
            canvas.onmouseout=hideTooltip;
        }
        
        function update(){
            filteredPoints=vizData.points.filter(d=>{
                let k=true;
                if(filters.topics.length>0&&!filters.topics.includes('all'))k=k&&filters.topics.includes(d.cluster);
                if(filters.ics.length>0&&!filters.ics.includes('all'))k=k&&filters.ics.includes(d.ic);
                k=k&&d.year>=filters.yearMin&&d.year<=filters.yearMax;
                return k;
            });
            document.getElementById('visibleCount').textContent=filteredPoints.length.toLocaleString();
            
            if(filters.colorBy==='cluster')colorScale=d3.scaleSequential(d3.interpolateRainbow).domain([0,100]);
            else if(filters.colorBy==='ic')colorScale=d3.scaleOrdinal(d3.schemeTableau10).domain([...new Set(vizData.points.map(d=>d.ic))].sort());
            else colorScale=d3.scaleSequential(d3.interpolateViridis).domain([2000,2024]);
            
            updateLegend();render();
        }
        
        function render(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const fs=new Set(filteredPoints.map(d=>d.application_id));
            vizData.points.forEach(d=>{
                const vis=fs.has(d.application_id);
                ctx.fillStyle=filters.colorBy==='cluster'?colorScale(d.cluster):filters.colorBy==='ic'?colorScale(d.ic):colorScale(d.year);
                ctx.globalAlpha=vis?0.7:0.08;
                ctx.beginPath();ctx.arc(xScale(d.x),yScale(d.y),2.5,0,Math.PI*2);ctx.fill();
            });
            ctx.globalAlpha=1;
        }
        
        function showTooltip(e,d){
            const c=vizData.clusters.find(x=>x.id===d.cluster),t=document.getElementById('tooltip');
            t.innerHTML=`<div class="tooltip-title">${d.title||'Grant '+d.application_id}</div>
                <div class="tooltip-item"><span class="tooltip-label">App ID:</span> ${d.application_id}</div>
                <div class="tooltip-item"><span class="tooltip-label">Topic:</span> ${d.cluster} - ${c?c.label.substring(0,40):'Unknown'}</div>
                <div class="tooltip-item"><span class="tooltip-label">IC:</span> ${d.ic}</div>
                <div class="tooltip-item"><span class="tooltip-label">Year:</span> ${d.year}</div>
                <div class="tooltip-item"><span class="tooltip-label">Cost:</span> $${(d.cost/1e6).toFixed(2)}M</div>`;
            t.style.display='block';t.style.left=(e.clientX+10)+'px';t.style.top=(e.clientY+10)+'px';
        }
        
        function hideTooltip(){document.getElementById('tooltip').style.display='none';}
        
        function populateFilters(){
            const ts=document.getElementById('topicFilter');
            vizData.clusters.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.id}: ${c.label.substring(0,40)} (${c.size})`;ts.appendChild(o);});
            const is=document.getElementById('icFilter'),ics=[...new Set(vizData.points.map(d=>d.ic))].sort();
            document.getElementById('icCount').textContent=ics.length;
            ics.forEach(ic=>{const o=document.createElement('option');o.value=ic;o.textContent=ic;is.appendChild(o);});
            
            let t;const u=()=>{clearTimeout(t);t=setTimeout(update,150);};
            document.getElementById('colorBy').onchange=e=>{filters.colorBy=e.target.value;u();};
            document.getElementById('topicFilter').onchange=e=>{filters.topics=Array.from(e.target.selectedOptions).map(o=>o.value==='all'?'all':parseInt(o.value));u();};
            document.getElementById('icFilter').onchange=e=>{filters.ics=Array.from(e.target.selectedOptions).map(o=>o.value);u();};
            document.getElementById('yearMin').onchange=e=>{filters.yearMin=parseInt(e.target.value);u();};
            document.getElementById('yearMax').onchange=e=>{filters.yearMax=parseInt(e.target.value);u();};
        }
        
        function resetFilters(){
            filters={topics:['all'],ics:['all'],yearMin:2000,yearMax:2024,colorBy:'cluster'};
            document.getElementById('topicFilter').selectedIndex=0;document.getElementById('icFilter').selectedIndex=0;
            document.getElementById('colorBy').value='cluster';
            document.getElementById('yearMin').value=2000;document.getElementById('yearMax').value=2024;
            update();
        }
        
        function updateLegend(){
            const l=document.getElementById('legend');
            l.innerHTML='<div class="legend-title">Color: '+filters.colorBy.toUpperCase()+'</div>';
            if(filters.colorBy==='cluster'){
                vizData.clusters.slice(0,15).forEach(c=>{
                    const i=document.createElement('div');i.className='legend-item';
                    const co=document.createElement('div');co.className='legend-color';co.style.backgroundColor=colorScale(c.id);
                    i.appendChild(co);const la=document.createElement('span');la.textContent=`${c.id}: ${c.label.substring(0,25)}`;
                    i.appendChild(la);l.appendChild(i);
                });
            }else if(filters.colorBy==='ic'){
                [...new Set(vizData.points.map(d=>d.ic))].sort().slice(0,20).forEach(ic=>{
                    const i=document.createElement('div');i.className='legend-item';
                    const co=document.createElement('div');co.className='legend-color';co.style.backgroundColor=colorScale(ic);
                    i.appendChild(co);const la=document.createElement('span');la.textContent=ic;
                    i.appendChild(la);l.appendChild(i);
                });
            }else{
                [2000,2006,2012,2018,2024].forEach(y=>{
                    const i=document.createElement('div');i.className='legend-item';
                    const co=document.createElement('div');co.className='legend-color';co.style.backgroundColor=colorScale(y);
                    i.appendChild(co);const la=document.createElement('span');la.textContent=y;
                    i.appendChild(la);l.appendChild(i);
                });
            }
        }
    </script>
</body>
</html>
