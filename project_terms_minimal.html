<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIH Topic Maps</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        .container { display: flex; height: calc(100vh - 70px); }
        .controls { width: 280px; background: white; border-right: 1px solid #ddd; overflow-y: auto; padding: 15px; }
        .viz { flex: 1; background: white; position: relative; }
        select { width: 100%; padding: 6px; margin-bottom: 8px; font-size: 12px; }
        label { display: block; font-weight: 600; font-size: 11px; margin-top: 15px; margin-bottom: 6px; }
        .stat { font-size: 12px; margin: 8px 0; }
        .point { cursor: pointer; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin: 0;">ðŸ§¬ NIH Topic Maps - PROJECT_TERMS</h1>
        <p style="margin: 5px 0 0 0; font-size: 13px;">5,000 sample grants | 100 topics | Select to filter</p>
    </div>
    
    <div class="container">
        <div class="controls">
            <label>Color By</label>
            <select id="colorBy">
                <option value="cluster">Topic</option>
                <option value="ic">IC</option>
                <option value="year">Year</option>
            </select>
            
            <label>Filter Topic</label>
            <select id="topicFilter">
                <option value="">All</option>
            </select>
            
            <label>Filter IC</label>
            <select id="icFilter">
                <option value="">All</option>
            </select>
            
            <div style="margin-top: 20px; background: #f8f9fa; padding: 12px; border-radius: 4px;">
                <div class="stat"><strong>Visible:</strong> <span id="visible">5,000</span></div>
                <div class="stat"><strong>Topics:</strong> 100</div>
                <div class="stat"><strong>ICs:</strong> <span id="icCount">27</span></div>
            </div>
        </div>
        
        <div class="viz">
            <svg id="svg"></svg>
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 4px; font-size: 12px; display: none;" id="tooltip"></div>
        </div>
    </div>
    
    <script>
        let data = null;
        let svg = null;
        let allPoints = [];
        
        fetch('https://storage.googleapis.com/od-cl-odss-conroyri-nih-embeddings/sample/viz_data_tight.json')
            .then(r => r.json())
            .then(d => {
                data = d;
                allPoints = d.points.slice();
                init();
                populate();
                render();
            })
            .catch(e => console.error(e));
        
        function init() {
            const w = document.querySelector('.viz').clientWidth;
            const h = document.querySelector('.viz').clientHeight;
            
            const xs = d3.extent(data.points, p => p.x);
            const ys = d3.extent(data.points, p => p.y);
            
            window.xScale = d3.scaleLinear().domain(xs).range([0, w]);
            window.yScale = d3.scaleLinear().domain(ys).range([h, 0]);
            
            svg = d3.select('#svg').attr('width', w).attr('height', h);
        }
        
        function populate() {
            const topics = document.getElementById('topicFilter');
            data.clusters.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.text = `${c.id}: ${c.l} (${c.s})`;
                topics.appendChild(opt);
            });
            
            const ics = [...new Set(data.points.map(p => p.ic))].sort();
            document.getElementById('icCount').textContent = ics.length;
            const icSel = document.getElementById('icFilter');
            ics.forEach(ic => {
                const opt = document.createElement('option');
                opt.value = ic;
                opt.text = ic;
                icSel.appendChild(opt);
            });
            
            document.getElementById('colorBy').addEventListener('change', render);
            document.getElementById('topicFilter').addEventListener('change', render);
            document.getElementById('icFilter').addEventListener('change', render);
        }
        
        function render() {
            const colorBy = document.getElementById('colorBy').value;
            const topic = document.getElementById('topicFilter').value;
            const ic = document.getElementById('icFilter').value;
            
            let filtered = data.points;
            if (topic) filtered = filtered.filter(p => p.c == topic);
            if (ic) filtered = filtered.filter(p => p.ic == ic);
            
            document.getElementById('visible').textContent = filtered.length.toLocaleString();
            
            let colorScale;
            if (colorBy === 'cluster') {
                colorScale = d3.scaleOrdinal(d3.schemeCategory10).domain(d3.range(100));
            } else if (colorBy === 'ic') {
                colorScale = d3.scaleOrdinal(d3.schemeTableau10);
            } else {
                colorScale = d3.scaleLinear().domain([2000, 2024]).range(['#fee5d9', '#a1d99b']);
            }
            
            svg.selectAll('.point').remove();
            svg.selectAll('.point')
                .data(data.points)
                .enter()
                .append('circle')
                .attr('class', 'point')
                .attr('cx', p => xScale(p.x))
                .attr('cy', p => yScale(p.y))
                .attr('r', 2)
                .attr('fill', p => {
                    if (colorBy === 'cluster') return colorScale(p.c);
                    if (colorBy === 'ic') return colorScale(p.ic);
                    return colorScale(p.y);
                })
                .attr('opacity', p => {
                    if (topic && p.c != topic) return 0.05;
                    if (ic && p.ic != ic) return 0.05;
                    return 0.6;
                });
        }
    </script>
</body>
</html>
