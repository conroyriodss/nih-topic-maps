<!DOCTYPE html><html><head><meta charset="UTF-8"><title>NIH Map - Improved Layout</title><script src="https://d3js.org/d3.v7.min.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;background:#f5f7fa;overflow:hidden}.header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px}h1{margin:0;font-size:24px}p{margin:5px 0 0 0;font-size:13px}.container{display:flex;height:calc(100vh - 70px)}.controls{width:340px;background:white;border-right:1px solid #ddd;padding:20px;overflow-y:auto}.viz{flex:1;position:relative;background:white}button{width:100%;padding:8px;margin:5px 0;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer}button:hover{background:#5568d3}button.active{background:#764ba2}select,input{width:100%;padding:8px;margin:5px 0;border:1px solid #ddd;border-radius:4px;box-sizing:border-box}label{display:block;font-weight:600;font-size:12px;margin-top:10px}.stats{background:#f8f9fa;padding:15px;border-radius:6px;font-size:12px;margin-top:20px}.tooltip{position:absolute;background:rgba(0,0,0,0.95);color:white;padding:12px;border-radius:6px;font-size:12px;display:none;z-index:50}</style></head><body><div class="header"><h1>NIH Topic Map (Improved Layout)</h1><p>43,320 grants | Tighter clustering + domain regions</p></div><div class="container"><div class="controls"><button id="b1" class="active" onclick="switchView('domains')">Domains</button><button id="b2" onclick="switchView('topics')">Topics</button><button id="b3" onclick="switchView('subtopics')">Subtopics</button><label for="df">Domain:</label><select id="df" multiple size="5"><option>All</option></select><label for="if">IC:</label><select id="if" multiple size="4"><option>All</option></select><label for="yn">Year Min:</label><input type="number" id="yn" value="2000" min="2000" max="2024"><label for="yx">Year Max:</label><input type="number" id="yx" value="2024" min="2000" max="2024"><button onclick="resetFilters()">Reset</button><div class="stats"><div style="display:flex;justify-content:space-between"><span>Visible:</span><span id="vc">0</span></div><div style="display:flex;justify-content:space-between"><span>ICs:</span><span id="ic">0</span></div></div></div><div class="viz" id="vz"></div><div id="tt" class="tooltip"></div></div><script>
const vz = document.getElementById('vz');
const canvas = document.createElement('canvas');
vz.appendChild(canvas);
console.log('Canvas created');

let d=null, v='domains', p=[], f={d:[], i:[], yn:2000, yx:2024}, regions=null;
const col=['#e74c3c','#3498db','#2ecc71','#f39c12','#9b59b6'];
const x = canvas.getContext('2d');
canvas.width = vz.clientWidth;
canvas.height = vz.clientHeight;
console.log('Canvas size:', canvas.width, 'x', canvas.height);

Promise.all([
  fetch('https://storage.googleapis.com/od-cl-odss-conroyri-nih-embeddings/sample/viz_data_3level_hierarchy_tight.json').then(r => r.json()),
  fetch('https://storage.googleapis.com/od-cl-odss-conroyri-nih-embeddings/sample/domain_regions.json').then(r => r.json())
])
.then(([data, regs]) => {
  d = data;
  regions = regs;
  console.log('Data loaded:', d.points.length, 'points');
  console.log('Regions loaded:', Object.keys(regions).length, 'domains');
  
  let xe = d3.extent(d.points, pt => pt.x);
  let ye = d3.extent(d.points, pt => pt.y);
  window.xs = d3.scaleLinear().domain(xe).range([30, canvas.width-30]);
  window.ys = d3.scaleLinear().domain(ye).range([canvas.height-30, 30]);
  
  let df = document.getElementById('df');
  df.innerHTML = '<option>All</option>' + d.domains.map(dm => '<option value="' + dm.id + '">' + dm.label + '</option>').join('');
  let ics = [...new Set(d.points.map(pt => pt.ic))].sort();
  document.getElementById('if').innerHTML = '<option>All</option>' + ics.map(ic => '<option>' + ic + '</option>').join('');
  document.getElementById('ic').textContent = ics.length;
  
  df.onchange = () => { f.d = Array.from(df.selectedOptions).map(o => o.value); draw(); };
  document.getElementById('if').onchange = () => { f.i = Array.from(document.getElementById('if').selectedOptions).map(o => o.value); draw(); };
  document.getElementById('yn').onchange = () => { f.yn = parseInt(document.getElementById('yn').value); draw(); };
  document.getElementById('yx').onchange = () => { f.yx = parseInt(document.getElementById('yx').value); draw(); };
  
  canvas.addEventListener('mousemove', e => {
    let r = canvas.getBoundingClientRect();
    let mx = e.clientX - r.left, my = e.clientY - r.top;
    for (let pt of p) {
      if (Math.abs(xs(pt.x) - mx) < 5 && Math.abs(ys(pt.y) - my) < 5) {
        let dm = d.domains.find(a => a.id === pt.domain);
        document.getElementById('tt').innerHTML = '<b>' + pt.ic + '</b> ' + pt.year + '<br>$' + (pt.cost/1e6).toFixed(2) + 'M<br>' + dm.label;
        document.getElementById('tt').style.left = mx + 20 + 'px';
        document.getElementById('tt').style.top = my + 10 + 'px';
        document.getElementById('tt').style.display = 'block';
        return;
      }
    }
    document.getElementById('tt').style.display = 'none';
  });
  
  function drawDomainRegions() {
    for (let domId in regions) {
      let reg = regions[domId];
      let x1 = xs(reg.x_min), y1 = ys(reg.y_max);
      let x2 = xs(reg.x_max), y2 = ys(reg.y_min);
      let w = x2 - x1, h = y2 - y1;
      
      x.fillStyle = col[domId];
      x.globalAlpha = 0.04;
      x.fillRect(x1, y1, w, h);
      
      x.strokeStyle = col[domId];
      x.globalAlpha = 0.15;
      x.lineWidth = 2;
      x.strokeRect(x1, y1, w, h);
    }
    x.globalAlpha = 1;
  }
  
  function draw() {
    p = d.points.filter(pt => {
      let ok = true;
      if (f.d.length > 0 && !f.d.includes('All') && !f.d.includes(pt.domain.toString())) ok = false;
      if (f.i.length > 0 && !f.i.includes('All') && !f.i.includes(pt.ic)) ok = false;
      if (pt.year < f.yn || pt.year > f.yx) ok = false;
      return ok;
    });
    document.getElementById('vc').textContent = p.length.toLocaleString();
    
    x.clearRect(0, 0, canvas.width, canvas.height);
    drawDomainRegions();
    
    let ps = new Set(p.map(pt => pt.application_id));
    d.points.forEach(pt => {
      let clr = v === 'domains' ? col[pt.domain] : v === 'topics' ? d3.interpolateRainbow(pt.topic / 13) : d3.interpolateRainbow(pt.subtopic / 24);
      x.fillStyle = clr;
      x.globalAlpha = ps.has(pt.application_id) ? 0.7 : 0.06;
      x.beginPath();
      x.arc(xs(pt.x), ys(pt.y), 2.5, 0, 6.28);
      x.fill();
    });
    x.globalAlpha = 1;
  }
  
  window.switchView = v2 => { v = v2; document.getElementById('b1').classList.toggle('active', v2 === 'domains'); document.getElementById('b2').classList.toggle('active', v2 === 'topics'); document.getElementById('b3').classList.toggle('active', v2 === 'subtopics'); draw(); };
  window.resetFilters = () => { f = {d:[], i:[], yn:2000, yx:2024}; document.getElementById('df').selectedIndex = 0; document.getElementById('if').selectedIndex = 0; document.getElementById('yn').value = 2000; document.getElementById('yx').value = 2024; draw(); };
  
  draw();
})
.catch(e => alert('Error: ' + e.message));
</script></body></html>
